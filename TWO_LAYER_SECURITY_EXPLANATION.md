# 2層セキュリティの説明

## 問題

現在、Cloud Runサービス自体へのアクセスが許可されていないため、403エラーが発生しています。

## 解決策：2層セキュリティ

### 第1層：Cloud Runサービスへのアクセス（必要）

**`allUsers`への公開アクセスを許可する必要があります。**

これは、Cloud Runサービス自体へのアクセスを許可するもので、**アプリケーションの機能にはアクセスできません**。

### 第2層：アプリケーションレベルの認証（実装済み）

**APIキー認証で保護されています。**

APIキーがないと、実際のAPIエンドポイント（`/api/gemini`など）は使用できません。

## セキュリティ上の利点

1. **誰でもCloud Runサービスにアクセスできる**
   - しかし、APIキーがないと実際のAPIは使用できない
   - 公開エンドポイント（`/`、`/health`）のみアクセス可能

2. **APIキーで保護**
   - すべてのAPIエンドポイント（`/api/gemini`、`/api/analyze`など）は認証が必要
   - APIキーがないと、401エラーが返される

3. **Secret Managerで管理**
   - APIキーはSecret Managerで安全に管理
   - 必要に応じて、APIキーをローテーション可能

## 設定方法

### Google Cloud Consoleから設定（推奨）

1. 以下のURLにアクセス：
   ```
   https://console.cloud.google.com/run/detail/asia-northeast1/ai-drbfm-backend/permissions?project=tamron-cloudrun-prod-new
   ```

2. 「プリンシパルを追加」をクリック

3. 以下を入力：
   - **新しいプリンシパル**: `allUsers`
   - **ロール**: `Cloud Run 起動元` または `roles/run.invoker`

4. 「保存」をクリック

### 設定後の動作

- ✅ 誰でもCloud Runサービスにアクセス可能（`/`、`/health`エンドポイント）
- ✅ APIキーがないと、`/api/gemini`などのAPIエンドポイントは使用不可（401エラー）
- ✅ APIキーがある場合のみ、APIエンドポイントが使用可能

## セキュリティ上の懸念への対応

### Q: `allUsers`にするとセキュリティが心配

**A: 問題ありません。理由：**

1. **アプリケーションレベルの認証で保護**
   - APIキーがないと、実際のAPIは使用できない
   - 公開エンドポイント（`/`、`/health`）のみアクセス可能

2. **APIキーはSecret Managerで管理**
   - APIキーはSecret Managerで安全に管理
   - 必要に応じて、APIキーをローテーション可能

3. **レート制限の追加も可能**
   - 必要に応じて、レート制限を追加して、過度なアクセスを防止

### より安全にする方法

1. **CORS設定を特定のドメインに制限**
   - 特定のドメインからのアクセスのみ許可

2. **レート制限の追加**
   - 過度なアクセスを防止

3. **IPアドレス制限**
   - 特定のIPアドレスからのアクセスのみ許可（ただし、フロントエンドが複数の場所からアクセスする場合は困難）

## 結論

**`allUsers`への公開アクセスを許可しても、APIキー認証で保護されているため、セキュリティは確保されています。**

これは、多くのWeb APIで使用されている一般的なセキュリティモデルです。
