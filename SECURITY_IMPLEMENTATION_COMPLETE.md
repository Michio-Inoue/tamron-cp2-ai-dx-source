# 繧ｻ繧ｭ繝･繧｢縺ｪAPI隱崎ｨｼ縺ｮ螳溯｣・ｮ御ｺ・

## 螳溯｣・・螳ｹ

### 1. 隱崎ｨｼ繝溘ラ繝ｫ繧ｦ繧ｧ繧｢縺ｮ霑ｽ蜉

`backend/auth-middleware.js`繧剃ｽ懈・縺励、PI繧ｭ繝ｼ讀懆ｨｼ讖溯・繧貞ｮ溯｣・＠縺ｾ縺励◆縲・

### 2. API繧ｭ繝ｼ縺ｮ邂｡逅・

- **Secret Manager**: `backend-api-key`縺ｨ縺・≧蜷榊燕縺ｧ菫晏ｭ・
- **逕滓・縺輔ｌ縺蘗PI繧ｭ繝ｼ**: `Lh8zeq73nXtaiMm5HSy4plGKNoxC9Qru`
- **IAM讓ｩ髯・*: Compute Engine繧ｵ繝ｼ繝薙せ繧｢繧ｫ繧ｦ繝ｳ繝医↓`secretmanager.secretAccessor`讓ｩ髯舌ｒ莉倅ｸ・

### 3. 繝輔Ο繝ｳ繝医お繝ｳ繝峨・譖ｴ譁ｰ

- `ai-drbfm.html`: API繧ｭ繝ｼ繧定ｨｭ螳・
- `ai-drbfm.js`: API蜻ｼ縺ｳ蜃ｺ縺玲凾縺ｫ`X-API-Key`繝倥ャ繝繝ｼ縺ｫAPI繧ｭ繝ｼ繧定ｿｽ蜉

### 4. 繝・・繝ｭ繧､

- Cloud Run繧ｵ繝ｼ繝薙せ縺ｫ隱崎ｨｼ繝溘ラ繝ｫ繧ｦ繧ｧ繧｢繧貞性繧繝舌ャ繧ｯ繧ｨ繝ｳ繝峨ｒ繝・・繝ｭ繧､
- Secret Manager縺九ｉAPI繧ｭ繝ｼ繧貞叙蠕励☆繧九ｈ縺・↓險ｭ螳・

## 繧ｻ繧ｭ繝･繝ｪ繝・ぅ荳翫・蛻ｩ轤ｹ

1. **`allUsers`縺ｸ縺ｮ蜈ｬ髢九い繧ｯ繧ｻ繧ｹ荳崎ｦ・*
   - Cloud Run繧ｵ繝ｼ繝薙せ閾ｪ菴薙・`--allow-unauthenticated`繝輔Λ繧ｰ縺ｧ蜈ｬ髢九＆繧後※縺・∪縺吶′縲・
   - 繧｢繝励Μ繧ｱ繝ｼ繧ｷ繝ｧ繝ｳ繝ｬ繝吶Ν縺ｮ隱崎ｨｼ・・PI繧ｭ繝ｼ・峨〒菫晁ｭｷ縺輔ｌ縺ｦ縺・∪縺・

2. **API繧ｭ繝ｼ縺ｮ邂｡逅・*
   - Secret Manager縺ｧ螳牙・縺ｫ邂｡逅・
   - 繝輔Ο繝ｳ繝医お繝ｳ繝峨↓蝓九ａ霎ｼ縺ｾ繧後※縺・∪縺吶′縲∝ｿ・ｦ√↓蠢懊§縺ｦ迺ｰ蠅・､画焚縺九ｉ蜿門ｾ励☆繧九％縺ｨ繧ょ庄閭ｽ

3. **隱崎ｨｼ縺ｮ螳溯｣・*
   - 縺吶∋縺ｦ縺ｮ`/api/gemini`縲～/api/analyze`縲～/api/save`繧ｨ繝ｳ繝峨・繧､繝ｳ繝医・隱崎ｨｼ縺悟ｿ・ｦ・
   - `/`縲～/health`繧ｨ繝ｳ繝峨・繧､繝ｳ繝医・隱崎ｨｼ荳崎ｦ・ｼ亥・髢具ｼ・

## 菴ｿ逕ｨ譁ｹ豕・

### 繝輔Ο繝ｳ繝医お繝ｳ繝峨°繧陰PI繧貞他縺ｳ蜃ｺ縺・

繝輔Ο繝ｳ繝医お繝ｳ繝峨・閾ｪ蜍慕噪縺ｫAPI繧ｭ繝ｼ繧帝∽ｿ｡縺励∪縺呻ｼ・

```javascript
fetch('https://ai-drbfm-backend-43iql33sfa-an.a.run.app/api/gemini', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'X-API-Key': window.BACKEND_API_KEY  // 閾ｪ蜍慕噪縺ｫ霑ｽ蜉縺輔ｌ繧・
    },
    body: JSON.stringify({ ... })
});
```

### API繧ｭ繝ｼ繧貞､画峩縺吶ｋ蝣ｴ蜷・

1. 譁ｰ縺励＞API繧ｭ繝ｼ繧堤函謌・
2. Secret Manager縺ｫ菫晏ｭ・
3. 繝輔Ο繝ｳ繝医お繝ｳ繝峨・`ai-drbfm.html`繧呈峩譁ｰ

## 豕ｨ諢丈ｺ矩・

1. **API繧ｭ繝ｼ縺ｮ菫晁ｭｷ**
   - 迴ｾ蝨ｨ縲、PI繧ｭ繝ｼ縺ｯ繝輔Ο繝ｳ繝医お繝ｳ繝峨↓蝓九ａ霎ｼ縺ｾ繧後※縺・∪縺・
   - 繧医ｊ螳牙・縺ｫ縺吶ｋ蝣ｴ蜷医・縲∫腸蠅・､画焚縺九ｉ蜿門ｾ励☆繧九°縲∝挨縺ｮ隱崎ｨｼ譁ｹ豕輔ｒ讀懆ｨ弱＠縺ｦ縺上□縺輔＞

2. **繝ｬ繝ｼ繝亥宛髯・*
   - 蠢・ｦ√↓蠢懊§縺ｦ縲√Ξ繝ｼ繝亥宛髯舌ｒ霑ｽ蜉縺吶ｋ縺薙→繧呈耳螂ｨ縺励∪縺・

3. **CORS險ｭ螳・*
   - 蠢・ｦ√↓蠢懊§縺ｦ縲，ORS險ｭ螳壹ｒ迚ｹ螳壹・繝峨Γ繧､繝ｳ縺ｫ蛻ｶ髯舌＠縺ｦ縺上□縺輔＞

## 谺｡縺ｮ繧ｹ繝・ャ繝・

1. 繝輔Ο繝ｳ繝医お繝ｳ繝峨°繧陰PI繧貞他縺ｳ蜃ｺ縺励※蜍穂ｽ懃｢ｺ隱・
2. 蠢・ｦ√↓蠢懊§縺ｦ縲√Ξ繝ｼ繝亥宛髯舌ｄCORS險ｭ螳壹ｒ霑ｽ蜉
3. API繧ｭ繝ｼ縺ｮ繝ｭ繝ｼ繝・・繧ｷ繝ｧ繝ｳ繧呈､懆ｨ・
